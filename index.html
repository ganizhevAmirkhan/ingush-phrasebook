<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Ingush Phrasebook</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- LameJS MP3 encoder -->
<script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>

<style>
:root {
    --bg: #ffffff;
    --fg: #000000;
    --card: #f4f4f4;
    --accent: #2a7cff;
}
.dark {
    --bg: #1a1a1a;
    --fg: #f0f0f0;
    --card: #2b2b2b;
    --accent: #5398ff;
}
body {
    margin: 0;
    padding: 0;
    background: var(--bg);
    color: var(--fg);
    font-family: Arial, sans-serif;
    transition: background .2s, color .2s;
}
header {
    padding: 15px;
    background: var(--card);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #ccc;
}
h1 { margin: 0; font-size: 22px; }

button {
    background: var(--accent);
    color: white;
    border: none;
    padding: 7px 12px;
    border-radius: 8px;
    cursor: pointer;
    margin: 3px;
}
button:hover { opacity: 0.9; }

#content {
    max-width: 900px;
    margin: auto;
    padding: 15px;
}

/* SEARCH BAR */
#searchBar {
    width: 100%;
    padding: 10px;
    font-size: 18px;
    border-radius: 8px;
    border: 2px solid #aaa;
    margin-bottom: 15px;
}

/* CATEGORY CARDS */
.category-card {
    background: var(--card);
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    cursor: pointer;
    font-size: 19px;
}
.category-card:hover { background: #dcdcdc; }

/* PHRASES */
.phrase-block {
    background: var(--card);
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 12px;
}
.phrase-top {
    font-size: 20px;
    font-weight: bold;
}
.phrase-ing {
    font-size: 20px;
    margin: 5px 0;
    color: var(--accent);
}
.phrase-pron {
    font-size: 15px;
}
.phrase-grammar {
    font-size: 13px;
    opacity: 0.8;
}

/* DIALOGS */
.dialog-card {
    background: var(--card);
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    cursor: pointer;
}
.dialog-step {
    background: var(--card);
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 8px;
}

/* MODAL WINDOWS */
.modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    display: none;
    justify-content: center;
    align-items: center;
}
.modal-content {
    background: var(--card);
    padding: 20px;
    width: 90%;
    max-width: 600px;
    border-radius: 12px;
}
.close-btn {
    float: right;
    cursor: pointer;
    font-size: 25px;
}

/* ADMIN PANEL */
#adminPanel {
    display: none;
    padding: 12px;
    background: var(--card);
    border-radius: 10px;
    margin-top: 20px;
    border: 2px solid var(--accent);
}
textarea {
    width: 100%;
    height: 150px;
    border-radius: 10px;
    padding: 10px;
}
</style>
</head>

<body>

<header>
    <h1>–ò–Ω–≥—É—à—Å–∫–æ‚Äì–†—É—Å—Å–∫–∏–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–∏–∫</h1>
    <div>
        <button onclick="toggleTheme()">üåô</button>
        <button onclick="openAdmin()">üîê Admin</button>
    </div>
</header>

<div id="content">

<input id="searchBar" placeholder="–ü–æ–∏—Å–∫ (—Ä—É—Å—Å–∫–∏–π –∏–ª–∏ –∏–Ω–≥—É—à—Å–∫–∏–π)‚Ä¶" oninput="globalSearch()"/>

<h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
<div id="categories"></div>

<h2>–î–∏–∞–ª–æ–≥–∏</h2>
<div id="dialogues"></div>

<div id="results"></div>

<!-- MODAL: ADMIN LOGIN -->
<div id="adminLoginModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeAdminLogin()">&times;</span>
    <h3>–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
    <input id="adminPasswordInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å"/><br><br>
    <button onclick="adminLogin()">–í–æ–π—Ç–∏</button>
  </div>
</div>

<!-- MODAL: EDIT PHRASE -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeEdit()">&times;</span>
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—Ä–∞–∑—É</h3>
    <input id="editRu" placeholder="–†—É—Å—Å–∫–∏–π"/><br><br>
    <input id="editIng" placeholder="–ò–Ω–≥—É—à—Å–∫–∏–π"/><br><br>
    <input id="editPron" placeholder="–ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ"/><br><br>
    <textarea id="editGrammar" placeholder="–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞"></textarea><br><br>
    <button onclick="saveEdit()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<!-- MODAL: ADD PHRASE -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeAdd()">&times;</span>
    <h3>–î–æ–±–∞–≤–∏—Ç—å —Ñ—Ä–∞–∑—É</h3>
    <input id="addRu" placeholder="–†—É—Å—Å–∫–∏–π"/><br><br>
    <input id="addIng" placeholder="–ò–Ω–≥—É—à—Å–∫–∏–π"/><br><br>
    <input id="addPron" placeholder="–ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ"/><br><br>
    <textarea id="addGrammar" placeholder="–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞"></textarea><br><br>
    <button onclick="saveNewPhrase()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel">
    <h3>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
    <button onclick="exportAll()">üì§ –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
    <button onclick="importJSON()">üì• –ò–º–ø–æ—Ä—Ç JSON</button>
</div>
<script>
// ================================
//          –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
// ================================
let PHRASES = {};        // –í—Å–µ —Ñ—Ä–∞–∑—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
let DIALOGUES = {};      // –í—Å–µ –¥–∏–∞–ª–æ–≥–∏
let currentCategory = ""; 
let editingPhrase = null;
let adminMode = false;

// ================================
//          –ó–ê–ì–†–£–ó–ö–ê JSON –§–ê–ô–õ–û–í
// ================================
async function loadJSON(path){
    const res = await fetch(path);
    return await res.json();
}

// –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
const CATEGORY_FILES = [
    "phrases/greetings.json",
    "phrases/family.json",
    "phrases/hunting.json",
    "phrases/travel.json",
    "phrases/danger.json",
    "phrases/commands.json",
    "phrases/home.json"
];

// –î–∏–∞–ª–æ–≥–∏
const DIALOGUE_FILES = [
    "dialogues/meeting.json",
    "dialogues/store.json",
    "dialogues/hunting.json",
    "dialogues/transport.json",
    "dialogues/conflict.json"
];

// ================================
//            –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ================================
async function init(){
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    for (let file of CATEGORY_FILES){
        let data = await loadJSON(file);
        PHRASES[data.category] = data;
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–∞–ª–æ–≥–∏
    for (let file of DIALOGUE_FILES){
        let data = await loadJSON(file);
        DIALOGUES[data.id] = data;
    }

    renderCategories();
    renderDialogues();
}
init();

// ================================
//         –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê
// ================================
function toggleTheme(){
    document.body.classList.toggle("dark");
}

// ================================
//       –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–ô
// ================================
function renderCategories(){
    let html = "";
    for (let key in PHRASES){
        let cat = PHRASES[key];
        html += `<div class="category-card" onclick="openCategory('${key}')">${cat.title}</div>`;
    }
    document.getElementById("categories").innerHTML = html;
}

// ================================
//            –û–¢–ö–†–´–¢–ò–ï –ö–ê–¢–ï–ì–û–†–ò–ò
// ================================
function openCategory(cat){
    currentCategory = cat;
    let c = PHRASES[cat];
    let html = `<h2>${c.title}</h2><button onclick="openAdd()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ñ—Ä–∞–∑—É</button>`;

    for (let p of c.phrases){
        html += `
        <div class="phrase-block">
            <div class="phrase-top">${p.ru}</div>
            <div class="phrase-ing">${p.ing}</div>
            <div class="phrase-pron">${p.pron || ""}</div>
            <div class="phrase-grammar">${p.grammar || ""}</div>
            <button onclick="speak('${p.ing}')">üîä</button>
            ${adminMode ? `<button onclick='editPhrase("${p.id}")'>‚úè</button>` : ""}
        </div>`;
    }
    document.getElementById("results").innerHTML = html;
}

// ================================
//         –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ò–ê–õ–û–ì–û–í
// ================================
function renderDialogues(){
    let html = "";
    for (let id in DIALOGUES){
        let d = DIALOGUES[id];
        html += `<div class="dialog-card" onclick="openDialogue('${id}')">${d.title}</div>`;
    }
    document.getElementById("dialogues").innerHTML = html;
}

function openDialogue(id){
    let d = DIALOGUES[id];
    let html = `<h2>${d.title}</h2>`;
    for (let step of d.steps){
        html += `
        <div class="dialog-step">
            <b>${step.speaker}:</b> ${step.ru}<br>
            <span style="color:var(--accent);">${step.ing}</span><br>
            <button onclick="speak('${step.ing}')">üîä</button>
        </div>`;
    }
    document.getElementById("results").innerHTML = html;
}

// ================================
//           –û–ó–í–£–ß–ö–ê TTS
// ================================
function speak(text){
    let utter = new SpeechSynthesisUtterance(text);
    utter.lang = "ru";
    speechSynthesis.speak(utter);
}

// ================================
//          –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ü–û–ò–°–ö
// ================================
function globalSearch(){
    let q = document.getElementById("searchBar").value.toLowerCase().trim();
    if (!q){ document.getElementById("results").innerHTML = ""; return; }

    let out = `<h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:</h2>`;
    let found = 0;

    for (let cat in PHRASES){
        for (let p of PHRASES[cat].phrases){
            if (p.ru.toLowerCase().includes(q) || p.ing.toLowerCase().includes(q)){
                found++;
                out += `
                <div class="phrase-block">
                    <div class="phrase-top">${p.ru}</div>
                    <div class="phrase-ing">${p.ing}</div>
                    <div class="phrase-pron">${p.pron || ""}</div>
                    <div class="phrase-grammar">${p.grammar || ""}</div>
                    <button onclick="speak('${p.ing}')">üîä</button>
                </div>`;
            }
        }
    }

    if (!found) out += "<p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>";
    document.getElementById("results").innerHTML = out;
}

// ================================
//       –û–ö–ù–ê (–ú–û–î–ê–õ–ö–ò)
// ================================
function openAdmin(){
    document.getElementById("adminLoginModal").style.display = "flex";
}
function closeAdminLogin(){
    document.getElementById("adminLoginModal").style.display = "none";
}
function openEdit(){ document.getElementById("editModal").style.display = "flex"; }
function closeEdit(){ document.getElementById("editModal").style.display = "none"; }
function openAdd(){ document.getElementById("addModal").style.display = "flex"; }
function closeAdd(){ document.getElementById("addModal").style.display = "none"; }

// ================================
//       SHA-256 –•–ï–®–ò–†–û–í–ê–ù–ò–ï
// ================================
async function sha256(str){
    const buf = new TextEncoder().encode(str);
    const digest = await crypto.subtle.digest("SHA-256", buf);
    return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

const ADMIN_HASH = "d3cc9d7cd837300b8eec3651fc4b68d1ce3996aa505284b2f482f3b0f436bb6e"; // SHA256("ingush-secret")

// ================================
//        –õ–û–ì–ò–ù –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê
// ================================
async function adminLogin(){
    let pass = document.getElementById("adminPasswordInput").value;
    let hash = await sha256(pass);
    if (hash === ADMIN_HASH){
        adminMode = true;
        document.getElementById("adminLoginModal").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
        alert("–ê–¥–º–∏–Ω-—Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.");
    } else {
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.");
    }
}

// ================================
//       –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –§–†–ê–ó–´
// ================================
function editPhrase(id){
    let c = PHRASES[currentCategory];
    let p = c.phrases.find(x => x.id === id);
    editingPhrase = p;

    document.getElementById("editRu").value = p.ru;
    document.getElementById("editIng").value = p.ing;
    document.getElementById("editPron").value = p.pron || "";
    document.getElementById("editGrammar").value = p.grammar || "";

    openEdit();
}

function saveEdit(){
    editingPhrase.ru = document.getElementById("editRu").value;
    editingPhrase.ing = document.getElementById("editIng").value;
    editingPhrase.pron = document.getElementById("editPron").value;
    editingPhrase.grammar = document.getElementById("editGrammar").value;

    closeEdit();
    openCategory(currentCategory);
}

// ================================
//        –î–û–ë–ê–í–õ–ï–ù–ò–ï –ù–û–í–û–ô –§–†–ê–ó–´
// ================================
function saveNewPhrase(){
    let ru = document.getElementById("addRu").value;
    let ing = document.getElementById("addIng").value;
    let pron = document.getElementById("addPron").value;
    let grammar = document.getElementById("addGrammar").value;

    let id = "p" + Math.random().toString(36).substr(2,9);

    PHRASES[currentCategory].phrases.push({
        id, ru, ing, pron, grammar
    });

    closeAdd();
    openCategory(currentCategory);
}
</script>
<script>
// ================================
//        –†–ï–ö–û–†–î–ï–† –ú–ò–ö–†–û–§–û–ù–ê
// ================================
let recorder;
let audioChunks = [];

async function startRecording(){
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recorder = new MediaRecorder(stream);

    audioChunks = [];
    recorder.ondataavailable = e => audioChunks.push(e.data);

    recorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        processRecording(audioBlob);
    };

    recorder.start();
    alert("–ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å‚Ä¶");
}

function stopRecording(){
    recorder.stop();
    alert("–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.");
}

// ================================
//      WAV ‚Üí MP3 (—á–µ—Ä–µ–∑ lamejs)
// ================================
async function processRecording(wavBlob){
    const arrayBuffer = await wavBlob.arrayBuffer();
    const wav = lamejs.WavHeader.readHeader(new DataView(arrayBuffer));

    const samples = new Int16Array(arrayBuffer, wav.dataOffset, wav.dataLen / 2);
    const mp3encoder = new lamejs.Mp3Encoder(wav.channels, wav.sampleRate, 128);
    let mp3Data = [];
    const sampleBlockSize = 1152;

    for (let i = 0; i < samples.length; i += sampleBlockSize) {
        const sampleChunk = samples.subarray(i, i + sampleBlockSize);
        const mp3buf = mp3encoder.encodeBuffer(sampleChunk);
        if (mp3buf.length > 0) mp3Data.push(mp3buf);
    }

    const end = mp3encoder.flush();
    if (end.length > 0) mp3Data.push(end);

    const mp3Blob = new Blob(mp3Data, { type: "audio/mp3" });

    // –ò–º—è —Ñ–∞–π–ª–∞ ‚Äî –∏–Ω–≥—É—à—Å–∫–æ–µ —Å–ª–æ–≤–æ –ª–∞—Ç–∏–Ω–∏—Ü–µ–π
    let filename = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–Ω–≥—É—à—Å–∫–æ–µ —Å–ª–æ–≤–æ (–¥–ª—è –∏–º–µ–Ω–∏ mp3-—Ñ–∞–π–ª–∞):");
    if (!filename) return alert("–§–∞–π–ª –æ—Ç–º–µ–Ω—ë–Ω.");

    filename = filename.replace(/[^a-zA-Z0-9_-]/g, "_") + ".mp3";

    uploadMP3toGitHub(mp3Blob, filename);
}

// ================================
//     –ó–ê–ì–†–£–ó–ö–ê MP3 –ù–ê GITHUB
// ================================
async function uploadMP3toGitHub(fileBlob, filename){
    let token = prompt("–í–≤–µ–¥–∏—Ç–µ GitHub Token –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:");
    if (!token){ alert("–û—Ç–º–µ–Ω–∞."); return; }

    const owner = "ganizhevAmirkhan";
    const repo = "ingush-phrasebook";
    const branch = "main";
    const path = `audio/${filename}`;

    const reader = new FileReader();
    reader.onload = async () => {
        const contentBase64 = reader.result.split(",")[1];

        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        const body = {
            message: `–î–æ–±–∞–≤–ª–µ–Ω mp3 —Ñ–∞–π–ª ${filename}`,
            content: contentBase64,
            branch: branch
        };

        let res = await fetch(url, {
            method: "PUT",
            headers: {
                "Authorization": "token " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
        });

        if (res.status === 201){
            alert("MP3 —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ GitHub!");
        } else {
            alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + res.status);
        }
    };
    reader.readAsDataURL(fileBlob);
}

// ================================
//          –≠–ö–°–ü–û–†–¢ JSON
// ================================
function exportAll(){
    const data = {
        phrases: PHRASES,
        dialogues: DIALOGUES
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    let a = document.createElement("a");
    a.href = url;
    a.download = "phrasebook_export.json";
    a.click();
}

// ================================
//        –ò–ú–ü–û–†–¢ JSON
// ================================
function importJSON(){
    let input = document.createElement("input");
    input.type = "file";
    input.accept = ".json";
    input.onchange = e => {
        let file = e.target.files[0];
        let reader = new FileReader();
        reader.onload = () => {
            let data = JSON.parse(reader.result);
            PHRASES = data.phrases;
            DIALOGUES = data.dialogues;
            renderCategories();
            renderDialogues();
            alert("JSON –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω.");
        };
        reader.readAsText(file);
    };
    input.click();
}
</script>

<!-- FOOTER -->
<div style="margin-top:50px; text-align:center; opacity:0.6;">
    Ingush Phrasebook ¬© 2025  
</div>

</body>
</html>

